let url,mapsKey,editing=!1;$(document).ready(function(){console.log(sessionStorage),sessionStorage.username&&(console.log("you are logged in"),$("#registerModalBtn").addClass("d-none"),$("#loginModalBtn").addClass("d-none"),$("#logoutBtn").removeClass("d-none"),$("#addAListing").removeClass("d-none"))}),$.ajax({url:"config.json",type:"GET",dataType:"json",error:e=>{console.log("There was an issue getting the config file"),console.log(e)},success:e=>{url=`${e.SERVER_URL}:${e.SERVER_PORT}`,mapsKey=e.GOOGLE_MAPS_KEY,getListingsData()}}),$("#registerForm").click(()=>{event.preventDefault();let e=!0;const s=$("#registerName").val(),t=$("#registerAddress").val(),n=$("#registerUsername").val(),i=$("#registerPassword").val(),l=$("#registerConfirmPassword").val(),a=$("#registerEmail").val(),r=$("#registerDOB").val();0===s.length?($("#registerName").addClass("is-invalid"),$("#registerName").parent().children().last().show(),e=!1):($("#registerName").removeClass("is-invalid"),$("#registerName").parent().children().last().hide()),0===t.length?($("#registerAddress").addClass("is-invalid"),$("#registerAddress").parent().children().last().show(),e=!1):($("#registerAddress").removeClass("is-invalid"),$("#registerAddress").parent().children().last().hide()),0===n.length?($("#registerUsername").addClass("is-invalid"),$("#registerUsername").parent().children().last().show(),e=!1):($("#registerUsername").removeClass("is-invalid"),$("#registerUsername").parent().children().last().hide()),i!==l||0===i.length||0===l.length?($("#registerPassword").addClass("is-invalid"),$("#registerPassword").parent().children().last().show(),$("#registerConfirmPassword").addClass("is-invalid"),$("#registerConfirmPassword").parent().children().last().show(),e=!1):($("#registerPassword").removeClass("is-invalid"),$("#registerPassword").parent().children().last().hide(),$("#registerConfirmPassword").removeClass("is-invalid"),$("#registerConfirmPassword").parent().children().last().hide()),0===a.length?($("#registerEmail").addClass("is-invalid"),$("#registerEmail").parent().children().last().show(),e=!1):($("#registerEmail").removeClass("is-invalid"),$("#registerEmail").parent().children().last().hide()),0===r.length?($("#registerDOB").addClass("is-invalid"),$("#registerDOB").parent().children().last().show(),e=!1):($("#registerDOB").removeClass("is-invalid"),$("#registerDOB").parent().children().last().hide()),e&&$.ajax({url:`${url}/registerUser`,type:"POST",data:{name:s,address:t,username:n,password:i,email:a,dob:r,registerDate:Date.now()},success:e=>{console.log(e),sessionStorage.userId=e._id,sessionStorage.username=e.username,sessionStorage.name=e.name,sessionStorage.email=e.email,sessionStorage.address=e.address,$("#registerName").val(null),$("#registerAddress").val(null),$("#registerUsername").val(null),$("#registerPassword").val(null),$("#registerConfirmPassword").val(null),$("#registerEmail").val(null),$("#registerDOB").val(null)},error:e=>{console.log(e),console.log("something went wrong")}})});const getListingsData=()=>{$.ajax({url:`${url}/allListings`,type:"GET",dataType:"json",success:e=>{console.log(e),$("#listingList").empty(),e.map(e=>{let s='<div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-3 mt-3 text-center"';s+='<div class="card h-100 border-dark" >',s+='<div class="card-body">',s+='<img src="" class="card-img-top" alt="">',s+=`<h5 class="card-title">${e.title}</h5>`,s+='<div class="d-flex justify-content-between">',s+=`<span>$${e.price}</span>`,s+='<div class="btn btn-primary">Edit</div>',s+="</div>",$("#listingList").append(s),$("#listingPageList").append(s)})}})};$("#listingForm").click(()=>{if(event.preventDefault(),sessionStorage.length>0&&sessionStorage.userId){let e=!0;const s=$("#listingTitle").val(),t=$("#listingDescription").val(),n=$("#listingPrice").val(),i=$("#listingImageFile").val();if(0===s.length?($("#listingTitle").addClass("is-invalid"),$("#listingTitle").parent().children().last().show(),e=!1):($("#listingTitle").removeClass("is-invalid"),$("#listingTitle").parent().children().last().hide()),0===t.length?($("#listingDescription").addClass("is-invalid"),$("#listingDescription").parent().children().last().show(),e=!1):($("#listingDescription").removeClass("is-invalid"),$("#listingDescription").parent().children().last().hide()),0===n.length?($("#listingPrice").addClass("is-invalid"),$("#listingPrice").parent().children().last().show(),e=!1):($("#listingPrice").removeClass("is-invalid"),$("#listingPrice").parent().children().last().hide()),0===i.length?($("#listingImageFile").addClass("is-invalid"),$("#listingImageFile").parent().children().last().show(),e=!1):($("#listingImageFile").removeClass("is-invalid"),$("#listingImageFile").parent().children().last().hide()),e){let e=new FormData;const i=$("#listingImageFile")[0].files[0];e.append("filePath",i),e.append("originalName",i.name),e.append("title",s),e.append("description",t),e.append("price",n),e.append("userId",sessionStorage.userId),$.ajax({url:`${url}/newListing`,method:"POST",data:e,contentType:!1,processData:!1,success:e=>{console.log("successful"),$("#listingTitle").val(null),$("#listingDescription").val(null),$("#listingPrice").val(null),$("#listingImageFile").val(null),$("#listingModal").modal("hide"),$(".toastListing").removeClass("d-none")},error:e=>{console.log(e),console.log("did not work")}})}}else console.log("You are not logged in")}),$("#loginForm").submit(()=>{event.preventDefault();let e=!0,s=$("#loginUsername").val(),t=$("#loginPassword").val();0===s.length?($("#loginUsername").addClass("is-invalid"),$("#loginUsername").parent().children().last().show(),e=!1):($("#loginUsername").removeClass("is-invalid"),$("#loginUsername").parent().children().last().hide()),0===t.length?($("#loginPassword").addClass("is-invalid"),$("#loginPassword").parent().children().last().show(),e=!1):($("#loginPassword").removeClass("is-invalid"),$("#loginPassword").parent().children().last().hide()),e?$.ajax({url:`${url}/login`,type:"POST",data:{username:s,password:t},error:e=>{console.log("Error logging in"),console.log(e)},success:e=>{console.log(e),sessionStorage.userId=e._id,sessionStorage.username=e.username,sessionStorage.name=e.name,sessionStorage.email=e.email,sessionStorage.address=e.address,$("#loginModal").modal("hide"),$("#registerModalBtn").addClass("d-none"),$("#loginModalBtn").addClass("d-none"),$("#logoutBtn").removeClass("d-none"),$("#addAListing").removeClass("d-none")}}):console.log("You have not filled in all the login inputs")}),$("#logoutBtn").click(()=>{sessionStorage.clear(),$("#logoutBtn").addClass("d-none"),$("#addAListing").addClass("d-none"),$("#registerModalBtn").removeClass("d-none"),$("#loginModalBtn").removeClass("d-none"),$(".loginActive").remove()}),$(".viewBtn").click(e=>{let s=$(e.target).attr("data-id");$("#itemCommentsParent").html(null),$.ajax({url:`${url}/product`,type:"POST",data:{id:s},error:e=>{console.log("Cant find listing"),console.log(e)},success:e=>{if($("#productPage").attr("data-listingId",e.info._id),$("#itemTitle").text(e.info.title),$("#itemImage").attr("style",`background-image: url('${e.info.filePath}')`),$("#itemPrice").text(`$${e.info.price}`),$("#description").text(e.info.description),$("#posterName").text(e.uploaderName),sessionStorage.length>0&&sessionStorage.userId&&($("#itemCommentsParent").html('<form class="loginActive" id="commentForm">\n\t\t\t\t\t<div class="d-flex">\n\t\t\t\t\t\t<input type="text" class="form-control" id="commentInput" placeholder="Add Question / Comment" required>\n\t\t\t\t\t\t<button type="submit" class="btn btn-primary">Post</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div id="commentValidation" class="invalid-feedback">Comment can not be empty</div>\n\t\t\t\t</form>'),$("#commentForm").submit(()=>{if(event.preventDefault(),sessionStorage.length>0&&sessionStorage.userId){let s=!0,t=$("#commentInput").val();0===t.length?($("#commentInput").addClass("is-invalid"),$("#commentValidation").parent().children().last().show(),s=!1):($("#commentInput").removeClass("is-invalid"),$("#commentValidation").parent().children().last().hide()),s?$.ajax({url:`${url}/addAComment`,type:"POST",data:{data:JSON.stringify({listingId:$("#productPage").attr("data-listingId"),commentUsername:sessionStorage.username,commentText:t,commentDate:Date.now(),commentUserId:sessionStorage.userId,reply:!1,replyUsername:null,replyText:null,replyDate:null,replyUserId:null})},success:s=>{$("#commentInput").val(null),$("#noCommentsMsg").hide();let t="";sessionStorage.length>0&&sessionStorage.userId==e.info.uploaderId?t+=`<div class="comment" data-commentId="${s._id}"><div class="d-flex justify-content-between"><h5>${s.commentUsername}</h5><button class="btn btn-primary btn-sm replyBtn loginActive">Reply</button></div><p>${s.commentText}</p></div>`:t+=`<div class="comment"><h5>${s.commentUsername}</h5><p>${s.commentText}</p></div>`,$("#itemComments").append(t),refreshReply()},error:e=>{console.log("did not post comment"),console.log(e)}}):console.log("Invalid text")}else console.log("You are not logged in")})),$("#itemCommentsParent").append('<div id="itemComments"></div>'),"No comments found"==e.comments)$("#itemComments").append('<h4 id="noCommentsMsg">No comments found.</h4>');else{let s="";e.comments.map(t=>{sessionStorage.length>0&&sessionStorage.userId==e.info.uploaderId?t.commentReply.reply?s+=`<div class="comment"><h5>${t.commentUsername}</h5><p>${t.commentText}</p>`:s+=`<div class="comment" data-commentId="${t._id}"><div class="d-flex justify-content-between"><h5>${t.commentUsername}</h5><button class="btn btn-primary btn-sm replyBtn loginActive">Reply</button></div><p>${t.commentText}</p>`:s+=`<div class="comment"><h5>${t.commentUsername}</h5><p>${t.commentText}</p>`,t.commentReply.reply?s+=`<div class="comment reply"><h5>${t.commentReply.replyUsername}</h5><p>${t.commentReply.replyText}</p></div></div>`:s+="</div>"}),$("#itemComments").append(s)}$("#homeContainer").hide(),$("#listingsPage").hide(),$("#productPage").removeClass("d-none"),refreshReply()}})});const refreshReply=()=>{$(".replyBtn").off("click"),$(".replyBtn").on("click",replyFunction)},replyFunction=e=>{$("#replyForm").remove();let s=$(e.target).parent().parent().attr("data-commentId");$(e.target).parent().parent().append('<form id="replyForm" class="loginActive">\n\t\t<div class="d-flex">\n\t\t\t<input type="text" class="form-control" id="replyInput" placeholder="Reply" required>\n\t\t\t<button type="submit" class="btn btn-primary">Post</button>\n\t\t</div>\n\t\t<div id="replyValidation" class="invalid-feedback">Comment can not be empty</div>\n\t</form>'),$("#replyForm").submit(()=>{event.preventDefault();let e=!0,t=$("#replyInput").val();0===t.length?($("#replyInput").addClass("is-invalid"),$("#replyValidation").parent().children().last().show(),e=!1):($("#replyInput").removeClass("is-invalid"),$("#replyValidation").parent().children().last().hide()),e&&$.ajax({url:`${url}/addReply`,type:"PATCH",data:{data:JSON.stringify({commentId:s,replyUsername:sessionStorage.username,replyText:t,replyDate:Date.now(),replyUserId:sessionStorage._id})},error:e=>{console.log("There was an error sending the reply"),console.log(e)},success:e=>{console.log("Reply submitted");let s=$("#replyForm").parent();$("#replyForm").remove(),s.append(`<div class="comment reply"><h5>${sessionStorage.username}</h5><p>${t}</p></div>`),s.find(".btn-sm").remove()}})})};