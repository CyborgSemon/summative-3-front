let url,onProductPage=!1;$(document).ready(()=>{sessionStorage.length>0&&sessionStorage.userId&&($("#registerModalBtn").addClass("d-none"),$("#loginModalBtn").addClass("d-none"),$("#logoutBtn").removeClass("d-none"),$("#addAListing").removeClass("d-none"))}),$.ajax({url:"config.json",type:"GET",dataType:"json",error:t=>{console.log("There was an issue getting the config file"),console.log(t)},success:t=>{url=`${t.SERVER_URL}:${t.SERVER_PORT}`,getHome()}}),$("#registerInstead").click(()=>{$("#loginModal").modal("hide"),setTimeout(()=>{$("#registerModal").modal("show")},500)}),$("#loginInstead").click(()=>{$("#registerModal").modal("hide"),setTimeout(()=>{$("#loginModal").modal("show")},500)}),$("#buyListing").click(()=>{sessionStorage.length>0&&sessionStorage.userId?($("#buyModal").modal({backdrop:"static",keyboard:!1}),$("#buyModal").modal("show")):$("#loginModal").modal("show")}),$("#buyProduct").click(()=>{sessionStorage.length>0&&sessionStorage.userId&&$.ajax({url:`${url}/buyListing`,type:"PATCH",data:{id:$("#productPage").attr("data-listingId"),userId:sessionStorage.userId},error:t=>{console.log(t)},success:t=>{"invalid"!=t?(onProductPage=!1,$("#buyModal").modal("hide"),$("#homeContainer").show(),$("#listingsPage").addClass("d-none"),$("#productPage").addClass("d-none"),getHome()):console.log("You can not buy your own listing")}})}),$("#registerForm").click(()=>{event.preventDefault();let t=!0;const e=$("#registerName").val(),s=$("#registerAddress").val(),i=$("#registerUsername").val(),n=$("#registerPassword").val(),a=$("#registerConfirmPassword").val(),l=$("#registerEmail").val(),o=$("#registerDOB").val();0===e.length?($("#registerName").addClass("is-invalid"),$("#registerName").parent().children().last().show(),t=!1):($("#registerName").removeClass("is-invalid"),$("#registerName").parent().children().last().hide()),0===s.length?($("#registerAddress").addClass("is-invalid"),$("#registerAddress").parent().children().last().show(),t=!1):($("#registerAddress").removeClass("is-invalid"),$("#registerAddress").parent().children().last().hide()),0===i.length?($("#registerUsername").addClass("is-invalid"),$("#registerUsername").parent().children().last().show(),t=!1):($("#registerUsername").removeClass("is-invalid"),$("#registerUsername").parent().children().last().hide()),n!==a||0===n.length||0===a.length?($("#registerPassword").addClass("is-invalid"),$("#registerPassword").parent().children().last().show(),$("#registerConfirmPassword").addClass("is-invalid"),$("#registerConfirmPassword").parent().children().last().show(),t=!1):($("#registerPassword").removeClass("is-invalid"),$("#registerPassword").parent().children().last().hide(),$("#registerConfirmPassword").removeClass("is-invalid"),$("#registerConfirmPassword").parent().children().last().hide()),0===l.length?($("#registerEmail").addClass("is-invalid"),$("#registerEmail").parent().children().last().show(),t=!1):($("#registerEmail").removeClass("is-invalid"),$("#registerEmail").parent().children().last().hide()),0===o.length?($("#registerDOB").addClass("is-invalid"),$("#registerDOB").parent().children().last().show(),t=!1):($("#registerDOB").removeClass("is-invalid"),$("#registerDOB").parent().children().last().hide()),t&&$.ajax({url:`${url}/registerUser`,type:"POST",data:{name:e,address:s,username:i,password:n,email:l,dob:o,registerDate:Date.now()},success:t=>{sessionStorage.userId=t._id,sessionStorage.username=t.username,sessionStorage.name=t.name,sessionStorage.email=t.email,sessionStorage.address=t.address,$("#registerName").val(null),$("#registerAddress").val(null),$("#registerUsername").val(null),$("#registerPassword").val(null),$("#registerConfirmPassword").val(null),$("#registerEmail").val(null),$("#registerDOB").val(null),$("#registerModal").modal("hide"),$("#loginModalBtn").addClass("d-none"),$("#registerModalBtn").addClass("d-none"),$("#addAListing").removeClass("d-none"),$("#logoutBtn").removeClass("d-none"),onProductPage?refreshCommentsDiv():refreshView()},error:t=>{console.log(t),console.log("Failed to regester user")}})});const getListingsData=()=>{$.ajax({url:`${url}/allListings`,type:"GET",dataType:"json",success:t=>{$("#listingPageList").html(null),t.map(t=>{let e="";e+='<div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-3 mt-3 text-center">',e+='<div class="card h-100 border-dark">',e+='<div class="card-body">',e+=`<div class="img-top" style="background-image: url('${url}/${t.filePath.replace(/\\/g,"/")}'); background-size: cover; background-position: center; background-repeat: no-repeat; height: 200px;">`,e+="</div>",e+=`<h5 class="card-title pt-2">${t.title}</h5>`,e+='<div class="d-flex justify-content-between">',e+=`<span>$${t.price}</span>`,e+=`<div class="btn btn-primary viewBtn" data-id="${t._id}">View</div>`,e+="</div>",e+="</div>",e+="</div>",$("#listingList").append(e),$("#listingPageList").append(e)}),refreshView()}})},getHome=()=>{$.ajax({url:`${url}/home`,type:"GET",dataType:"json",success:t=>{$("#featuredListing").html(`<div class="container">\n\t\t\t\t\t\t\t\t\t\t\t<div class="row">\n\t\t\t\t\t\t\t\t\t\t\t\t<h3 class="text-center featuredTitle">Featured Listing</h3>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="card mb-3 border-dark" style="width: 100%;">\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="row no-gutters">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="col-md-4" style="background-image: url('${url}/${t[0].filePath.replace(/\\/g,"/")}'); background-size: cover; background-position: center; background-repeat: no-repeat; height: 300px;">\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="col-md-8">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="card-body" style="max-height: 100%; margin: 0 auto;">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<h5 class="card-title">${t[0].title}</h5>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<p class="card-text">${t[0].description}</p>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="row">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="col">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<p class="card-text">$${t[0].price}</p>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="col d-flex justify-content-end">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<button class="btn btn-secondary viewBtn" data-id="${t[0]._id}">Learn More</button>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>`),$("#listingList").html(null),t.map((e,s)=>{if(s>0){let e="";e+='<div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-3 mt-3 text-center">',e+='<div class="card h-100 border-dark">',e+='<div class="card-body">',e+=`<div class="img-top" style="background-image: url('${url}/${t[s].filePath.replace(/\\/g,"/")}'); background-size: cover; background-position: center; background-repeat: no-repeat; height: 200px;">`,e+="</div>",e+=`<h5 class="card-title pt-2">${t[s].title}</h5>`,e+='<div class="d-flex justify-content-between">',e+=`<span>$${t[s].price}</span>`,e+=`<div class="btn btn-primary viewBtn" data-id="${t[s]._id}">View</div>`,e+="</div>",e+="</div>",e+="</div>",$("#listingList").append(e)}}),refreshView()},error:t=>{console.log(t),console.log("could not get the home page listings")}})};$("#listingsPageBtn").click(()=>{onProductPage=!1,$("#homeContainer").hide(),$("#listingsPage").removeClass("d-none"),$("#productPage").addClass("d-none"),$.ajax({url:`${url}/allListings`,type:"GET",dataType:"json",success:t=>{$("#listingPageList").html(null),t.map(t=>{let e="";e+='<div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-3 mt-3 text-center">',e+='<div class="card h-100 border-dark">',e+='<div class="card-body">',e+=`<div class="img-top" style="background-image: url('${url}/${t.filePath.replace(/\\/g,"/")}'); background-size: cover; background-position: center; background-repeat: no-repeat; height: 200px;">`,e+="</div>",e+=`<h5 class="card-title pt-2">${t.title}</h5>`,e+='<div class="d-flex justify-content-between">',e+=`<span>$${t.price}</span>`,e+=`<div class="btn btn-primary viewBtn" data-id="${t._id}">View</div>`,e+="</div>",e+="</div>",e+="</div>",$("#listingList").append(e),$("#listingPageList").append(e)}),refreshView()}})}),$("#homeBtn").click(()=>{onProductPage=!1,$("#homeContainer").show(),$("#listingsPage").addClass("d-none"),$("#productPage").addClass("d-none"),getHome()}),$("#addAListing").click(()=>{$("#listingModal").modal("show")}),$("#listingImageFile").change(()=>{$("#fileUploadLabel").text($("#listingImageFile")[0].files[0].name)}),$("#listingForm").click(()=>{if(event.preventDefault(),sessionStorage.length>0&&sessionStorage.userId){let t=!0;const e=$("#listingTitle").val(),s=$("#listingDescription").val(),i=$("#listingPrice").val(),n=$("#listingImageFile").val();if(0===e.length?($("#listingTitle").addClass("is-invalid"),$("#listingTitle").parent().children().last().show(),t=!1):($("#listingTitle").removeClass("is-invalid"),$("#listingTitle").parent().children().last().hide()),0===s.length?($("#listingDescription").addClass("is-invalid"),$("#listingDescription").parent().children().last().show(),t=!1):($("#listingDescription").removeClass("is-invalid"),$("#listingDescription").parent().children().last().hide()),0===i.length?($("#listingPrice").addClass("is-invalid"),$("#listingPrice").parent().children().last().show(),t=!1):($("#listingPrice").removeClass("is-invalid"),$("#listingPrice").parent().children().last().hide()),0===n.length?($("#listingImageFile").addClass("is-invalid"),$("#listingImageFile").parent().children().last().show(),t=!1):($("#listingImageFile").removeClass("is-invalid"),$("#listingImageFile").parent().children().last().hide()),t){let t=new FormData;const n=$("#listingImageFile")[0].files[0];t.append("filePath",n),t.append("originalName",n.name),t.append("title",e),t.append("description",s),t.append("price",i),t.append("userId",sessionStorage.userId),$.ajax({url:`${url}/newListing`,method:"POST",data:t,contentType:!1,processData:!1,success:t=>{$("#listingTitle").val(null),$("#listingDescription").val(null),$("#listingPrice").val(null),$("#listingImageFile").val(null),$("#fileUploadLabel").text("Upload an Image"),$("#toastNotification").html('<div class="toast-header">\n\t\t\t    \t\t<strong class="mr-auto">Congratulations!</strong>\n\t\t\t\t\t\t<small class="pl-2 text-muted">just now</small>\n\t\t\t    \t\t<button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">\n\t\t\t      \t\t\t<span aria-hidden="true">&times;</span>\n\t\t\t    \t\t</button>\n\t\t\t  \t\t</div>\n\t\t\t  \t\t<div class="toast-body">\n\t\t\t    \t\tYour listing was posted!\n\t\t\t  \t\t</div>'),$("#toastNotification").toast("show"),$("#listingModal").modal("hide")},error:t=>{console.log(t),console.log("Could not add listing")}})}}else console.log("You are not logged in")}),$("#loginForm").submit(()=>{event.preventDefault();let t=!0,e=$("#loginUsername").val(),s=$("#loginPassword").val();0===e.length?($("#loginUsername").addClass("is-invalid"),$("#loginUsername").parent().children().last().show(),t=!1):($("#loginUsername").removeClass("is-invalid"),$("#loginUsername").parent().children().last().hide()),0===s.length?($("#loginPassword").addClass("is-invalid"),$("#loginPassword").parent().children().last().show(),t=!1):($("#loginPassword").removeClass("is-invalid"),$("#loginPassword").parent().children().last().hide()),t&&$.ajax({url:`${url}/login`,type:"POST",data:{username:e,password:s},error:t=>{console.log("Error logging in"),console.log(t)},success:t=>{let e=!0;"Invalid Username"==t&&(e=!1,$("#loginUsername").addClass("is-invalid"),$("#loginUsername").parent().children().last().show()),"Invalid Password"==t&&(e=!1,$("#loginPassword").addClass("is-invalid"),$("#loginPassword").parent().children().last().show()),e&&(sessionStorage.userId=t._id,sessionStorage.username=t.username,sessionStorage.name=t.name,sessionStorage.email=t.email,sessionStorage.address=t.address,$("#loginModal").modal("hide"),$("#registerModalBtn").addClass("d-none"),$("#loginModalBtn").addClass("d-none"),$("#logoutBtn").removeClass("d-none"),$("#addAListing").removeClass("d-none"),onProductPage&&refreshCommentsDiv($("#productPage")[0]))}})}),$("#logoutBtn").click(()=>{sessionStorage.clear(),$("#buyListing").removeClass("d-none"),$("#logoutBtn").addClass("d-none"),$("#addAListing").addClass("d-none"),$("#registerModalBtn").removeClass("d-none"),$("#loginModalBtn").removeClass("d-none"),$(".loginActive").remove(),$(".loginActiveHide").addClass("d-none"),$("#toastNotification").html('<div class="toast-header">\n\t\t<strong class="mr-auto">Logging out</strong>\n\t\t<small class="pl-2 text-muted">just now</small>\n\t\t<button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">\n\t\t\t<span aria-hidden="true">&times;</span>\n\t\t</button>\n\t</div>\n\t<div class="toast-body">\n\t\tYou are now logged out of your account\n\t</div>'),setTimeout(()=>{$("#toastNotification").toast("show")},250)});const refreshView=()=>{$(".viewBtn").click(t=>{onProductPage=!0,refreshCommentsDiv(t.target)})},refreshCommentsDiv=t=>{let e=$(t).attr("data-id")||$(t).attr("data-listingid");$("#itemCommentsParent").html(null),$.ajax({url:`${url}/product`,type:"POST",data:{id:e},error:t=>{console.log("Cant find listing"),console.log(t)},success:t=>{if($("#productPage").attr("data-listingId",t.info._id),$("#itemTitle").text(t.info.title),sessionStorage.userId==t.info.uploaderId?($("#buyListing").addClass("d-none"),$("#productBtns").removeClass("d-none")):($("#buyListing").removeClass("d-none"),$("#productBtns").addClass("d-none")),$("#itemImage").attr("style",`background-image: url('${url}/${t.info.filePath.replace(/\\/g,"/")}')`),$("#itemPrice").text(`$${t.info.price}`),$("#itemDescription").text(t.info.description),$("#posterName").text(t.uploaderName),sessionStorage.length>0&&sessionStorage.userId&&($("#itemCommentsParent").html('<form class="loginActive" id="commentForm">\n\t\t\t\t\t<div class="d-flex">\n\t\t\t\t\t\t<input type="text" class="form-control" id="commentInput" placeholder="Add Question / Comment" required>\n\t\t\t\t\t\t<button type="submit" class="btn btn-primary">Post</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div id="commentValidation" class="invalid-feedback">Comment can not be empty</div>\n\t\t\t\t</form>'),$("#commentForm").submit(()=>{if(event.preventDefault(),sessionStorage.length>0&&sessionStorage.userId){let e=!0,s=$("#commentInput").val();0===s.length?($("#commentInput").addClass("is-invalid"),$("#commentValidation").parent().children().last().show(),e=!1):($("#commentInput").removeClass("is-invalid"),$("#commentValidation").parent().children().last().hide()),e&&$.ajax({url:`${url}/addAComment`,type:"POST",data:{data:JSON.stringify({listingId:$("#productPage").attr("data-listingId"),commentUsername:sessionStorage.username,commentText:s,commentDate:Date.now(),commentUserId:sessionStorage.userId,reply:!1,replyUsername:null,replyText:null,replyDate:null,replyUserId:null})},success:e=>{$("#commentInput").val(null),$("#noCommentsMsg").hide();let s="";sessionStorage.length>0&&sessionStorage.userId==t.info.uploaderId?s+=`<div class="comment" data-commentId="${e._id}"><div class="d-flex justify-content-between"><h5>${e.commentUsername}</h5><button class="btn btn-primary btn-sm replyBtn loginActive">Reply</button></div><p>${e.commentText}</p></div>`:s+=`<div class="comment"><h5>${e.commentUsername}</h5><p>${e.commentText}</p></div>`,$("#itemComments").append(s),refreshReply()},error:t=>{console.log("did not post comment"),console.log(t)}})}else console.log("You are not logged in")})),$("#itemCommentsParent").append('<div id="itemComments"></div>'),"No comments found"==t.comments)$("#itemComments").html(null),$("#itemComments").append('<h4 id="noCommentsMsg">No comments found.</h4>');else{let e="";t.comments.map(s=>{sessionStorage.length>0&&sessionStorage.userId==t.info.uploaderId?s.commentReply.reply?e+=`<div class="comment"><h5>${s.commentUsername}</h5><p>${s.commentText}</p>`:e+=`<div class="comment" data-commentId="${s._id}"><div class="d-flex justify-content-between"><h5>${s.commentUsername}</h5><button class="btn btn-primary btn-sm replyBtn loginActive">Reply</button></div><p>${s.commentText}</p>`:e+=`<div class="comment"><h5>${s.commentUsername}</h5><p>${s.commentText}</p>`,s.commentReply.reply?e+=`<div class="comment reply"><h5>${s.commentReply.replyUsername}</h5><p>${s.commentReply.replyText}</p></div></div>`:e+="</div>"}),$("#itemComments").append(e)}$("#homeContainer").hide(),$("#listingsPage").addClass("d-none"),$("#productPage").removeClass("d-none"),refreshReply()}})},refreshReply=()=>{$(".replyBtn").off("click"),$(".replyBtn").on("click",replyFunction)},replyFunction=t=>{$("#replyForm").remove();let e=$(t.target).parent().parent().attr("data-commentId");$(t.target).parent().parent().append('<form id="replyForm" class="loginActive">\n\t\t<div class="d-flex">\n\t\t\t<input type="text" class="form-control" id="replyInput" placeholder="Reply" required>\n\t\t\t<button type="submit" class="btn btn-primary">Post</button>\n\t\t</div>\n\t\t<div id="replyValidation" class="invalid-feedback">Comment can not be empty</div>\n\t</form>'),$("#replyForm").submit(()=>{event.preventDefault();let t=!0,s=$("#replyInput").val();0===s.length?($("#replyInput").addClass("is-invalid"),$("#replyValidation").parent().children().last().show(),t=!1):($("#replyInput").removeClass("is-invalid"),$("#replyValidation").parent().children().last().hide()),t&&$.ajax({url:`${url}/addReply`,type:"PATCH",data:{data:JSON.stringify({commentId:e,replyUsername:sessionStorage.username,replyText:s,replyDate:Date.now(),replyUserId:sessionStorage._id})},error:t=>{console.log("There was an error sending the reply"),console.log(t)},success:t=>{let e=$("#replyForm").parent();$("#replyForm").remove(),e.append(`<div class="comment reply"><h5>${sessionStorage.username}</h5><p>${s}</p></div>`),e.find(".btn-sm").remove()}})})};$("#editListingForm").click(()=>{if(event.preventDefault(),sessionStorage.length>0&&sessionStorage.userId){let t=!0;const e=$("#editListingTitle").val(),s=$("#editListingDescription").val(),i=$("#editListingPrice").val();0===e.length?($("#editListingTitle").addClass("is-invalid"),$("#editListingTitle").parent().children().last().show(),t=!1):($("#editListingTitle").removeClass("is-invalid"),$("#editListingTitle").parent().children().last().hide()),0===s.length?($("#editListingDescription").addClass("is-invalid"),$("#editListingDescription").parent().children().last().show(),t=!1):($("#editListingDescription").removeClass("is-invalid"),$("#editListingDescription").parent().children().last().hide()),0===i.length?($("#editListingPrice").addClass("is-invalid"),$("#editListingPrice").parent().children().last().show(),t=!1):($("#editListingPrice").removeClass("is-invalid"),$("#editListingPrice").parent().children().last().hide()),t&&$.ajax({url:`${url}/updateListing`,type:"PATCH",data:{id:$("#productPage").attr("data-listingId"),title:e,description:s,price:i,userId:sessionStorage.userId},success:t=>{$("#itemTitle").text(e),$("#itemDescription").text(s),$("#itemPrice").text(`$${i}`),$("#editListingModal").modal("hide"),$("#editListingTitle").val(null),$("#editListingDescription").val(null),$("#editListingPrice").val(null)},error:t=>{console.log(t),console.log("did not work")}})}else console.log("You are not logged in")}),$("#editBtn").click(()=>{$("#editListingTitle").val($("#itemTitle").text()),$("#editListingDescription").val($("#itemDescription").text()),$("#editListingPrice").val(parseInt($("#itemPrice").text().replace(/[^a-zA-Z0-9 ]/g,""))),$("#editListingModal").modal("show")}),$("#removeBtn").click(()=>{sessionStorage.userId?$.ajax({url:`${url}/deleteListing`,type:"DELETE",data:{id:$("#productPage").attr("data-listingId"),userId:sessionStorage.userId},success:t=>{"deleted"==t?($("#homeContainer").show(),$("#listingsPage").addClass("d-none"),$("#productPage").addClass("d-none"),$("#productPage").attr("data-listingId",null),getHome()):(console.log("Failed to delete"),console.log(t))},error:t=>{console.log(t),console.log("something went wrong deleting the product")}}):alert("401, permission denied")});